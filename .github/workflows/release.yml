# Pokemon GO æ¸¸æˆå‘å¸ƒå·¥ä½œæµ
# å¼€å‘å¿ƒç†ï¼šè‡ªåŠ¨åŒ–æž„å»ºå’Œå‘å¸ƒæµç¨‹ï¼Œç¡®ä¿è·¨å¹³å°å…¼å®¹æ€§
# æ”¯æŒWindows, macOS, Linuxä¸‰å¤§å¹³å°çš„è‡ªåŠ¨æž„å»ºå’Œå‘å¸ƒ

name: ðŸŽ® Pokemon GO Release

on:
  push:
    tags:
      - 'v*'  # å½“æŽ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘
  release:
    types: [created]
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

env:
  CARGO_TERM_COLOR: always
  GAME_NAME: pokemongo

jobs:
  # Windows æž„å»ºä»»åŠ¡
  build-windows:
    name: ðŸªŸ Windows Build
    runs-on: windows-latest
    
    steps:
    - name: ðŸ“¦ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸ¦€ Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        target: x86_64-pc-windows-msvc
        
    - name: ðŸ”§ Setup CMake
      uses: jwlawson/actions-setup-cmake@v1
      with:
        cmake-version: '3.20'
        
    - name: ðŸ—ï¸ Setup MSBuild
      uses: microsoft/setup-msbuild@v1
      
    - name: ðŸ“‹ Install Dependencies
      run: |
        echo "å®‰è£…Windowsæž„å»ºä¾èµ–"
        
    - name: ðŸš€ Build C++ Native Modules
      run: |
        mkdir build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -A x64
        cmake --build . --config Release --parallel
        cd ..
        
    - name: ðŸ¦€ Build Rust Project
      run: |
        cargo build --release --no-default-features --target x86_64-pc-windows-msvc
        
    - name: ðŸ§ª Run Tests
      run: |
        cargo test --no-default-features --target x86_64-pc-windows-msvc
        
    - name: ðŸ“¦ Package Windows Release
      run: |
        mkdir pokemon-go-windows
        copy target\x86_64-pc-windows-msvc\release\pokemongo.exe pokemon-go-windows\
        copy target\x86_64-pc-windows-msvc\release\*.dll pokemon-go-windows\ 2>nul || echo "No DLLs to copy"
        xcopy assets pokemon-go-windows\assets\ /E /I /Y
        copy README.md pokemon-go-windows\
        copy GAME_MODES.md pokemon-go-windows\
        
        # åˆ›å»ºå¯åŠ¨è„šæœ¬
        echo @echo off > pokemon-go-windows\run.bat
        echo echo ðŸŽ® å¯åŠ¨ Pokemon GO é«˜æ€§èƒ½æ¸¸æˆ... >> pokemon-go-windows\run.bat
        echo pokemongo.exe >> pokemon-go-windows\run.bat
        echo pause >> pokemon-go-windows\run.bat
        
        # åŽ‹ç¼©å‘å¸ƒåŒ…
        powershell Compress-Archive -Path pokemon-go-windows -DestinationPath pokemon-go-windows-x64.zip
        
    - name: ðŸ“¤ Upload Windows Artifact
      uses: actions/upload-artifact@v4
      with:
        name: pokemon-go-windows-x64
        path: pokemon-go-windows-x64.zip
        retention-days: 30

  # macOS æž„å»ºä»»åŠ¡
  build-macos:
    name: ðŸŽ macOS Build
    runs-on: macos-latest
    
    steps:
    - name: ðŸ“¦ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸ¦€ Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        target: x86_64-apple-darwin
        
    - name: ðŸ”§ Setup CMake
      run: brew install cmake
      
    - name: ðŸš€ Build C++ Native Modules
      run: |
        mkdir build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release
        make -j$(sysctl -n hw.ncpu)
        cd ..
        
    - name: ðŸ¦€ Build Rust Project
      run: |
        cargo build --release --no-default-features --target x86_64-apple-darwin
        
    - name: ðŸ§ª Run Tests
      run: |
        cargo test --no-default-features --target x86_64-apple-darwin
        
    - name: ðŸ“¦ Package macOS Release
      run: |
        mkdir pokemon-go-macos
        cp target/x86_64-apple-darwin/release/pokemongo pokemon-go-macos/
        cp -r assets pokemon-go-macos/
        cp README.md GAME_MODES.md pokemon-go-macos/
        
        # åˆ›å»ºå¯åŠ¨è„šæœ¬
        echo '#!/bin/bash' > pokemon-go-macos/run.sh
        echo 'echo "ðŸŽ® å¯åŠ¨ Pokemon GO é«˜æ€§èƒ½æ¸¸æˆ..."' >> pokemon-go-macos/run.sh
        echo './pokemongo' >> pokemon-go-macos/run.sh
        chmod +x pokemon-go-macos/run.sh
        chmod +x pokemon-go-macos/pokemongo
        
        tar -czf pokemon-go-macos-x64.tar.gz pokemon-go-macos
        
    - name: ðŸ“¤ Upload macOS Artifact
      uses: actions/upload-artifact@v4
      with:
        name: pokemon-go-macos-x64
        path: pokemon-go-macos-x64.tar.gz
        retention-days: 30

  # Linux æž„å»ºä»»åŠ¡
  build-linux:
    name: ðŸ§ Linux Build
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¦ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸ¦€ Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        target: x86_64-unknown-linux-gnu
        
    - name: ðŸ“‹ Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential pkg-config \
          libasound2-dev libudev-dev libxcb1-dev libxcb-render-dev \
          libxcb-shape-dev libxcb-xfixes-dev libspeechd-dev libxkbcommon-dev \
          libssl-dev libatk-bridge2.0-dev libgtk-3-dev
          
    - name: ðŸš€ Build C++ Native Modules
      run: |
        mkdir build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release
        make -j$(nproc)
        cd ..
        
    - name: ðŸ¦€ Build Rust Project
      run: |
        cargo build --release --no-default-features --target x86_64-unknown-linux-gnu
        
    - name: ðŸ§ª Run Tests
      run: |
        cargo test --no-default-features --target x86_64-unknown-linux-gnu
        
    - name: ðŸ“¦ Package Linux Release
      run: |
        mkdir pokemon-go-linux
        cp target/x86_64-unknown-linux-gnu/release/pokemongo pokemon-go-linux/
        cp -r assets pokemon-go-linux/
        cp README.md GAME_MODES.md pokemon-go-linux/
        
        # åˆ›å»ºå¯åŠ¨è„šæœ¬
        echo '#!/bin/bash' > pokemon-go-linux/run.sh
        echo 'echo "ðŸŽ® å¯åŠ¨ Pokemon GO é«˜æ€§èƒ½æ¸¸æˆ..."' >> pokemon-go-linux/run.sh
        echo './pokemongo' >> pokemon-go-linux/run.sh
        chmod +x pokemon-go-linux/run.sh
        chmod +x pokemon-go-linux/pokemongo
        
        tar -czf pokemon-go-linux-x64.tar.gz pokemon-go-linux
        
    - name: ðŸ“¤ Upload Linux Artifact
      uses: actions/upload-artifact@v4
      with:
        name: pokemon-go-linux-x64
        path: pokemon-go-linux-x64.tar.gz
        retention-days: 30

  # åˆ›å»ºGitHub Release
  create-release:
    name: ðŸš€ Create GitHub Release
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: ðŸ“¦ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸ“¥ Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
        
    - name: ðŸ“‹ Generate Release Notes
      id: release_notes
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
        cat > release_notes.md << EOF
        # ðŸŽ® Pokemon GO $VERSION å‘å¸ƒ
        
        ## ðŸ“¦ ä¸‹è½½
        
        ### Windows (æŽ¨è)
        - **pokemon-go-windows-x64.zip** - Windows 10/11 x64ç‰ˆæœ¬
        - ä¸‹è½½åŽè§£åŽ‹ï¼Œè¿è¡Œ \`run.bat\` å³å¯å¼€å§‹æ¸¸æˆ
        
        ### macOS
        - **pokemon-go-macos-x64.tar.gz** - macOS 10.15+ x64ç‰ˆæœ¬
        - ä¸‹è½½åŽè§£åŽ‹ï¼Œè¿è¡Œ \`./run.sh\` å¼€å§‹æ¸¸æˆ
        
        ### Linux
        - **pokemon-go-linux-x64.tar.gz** - Ubuntu 20.04+ x64ç‰ˆæœ¬
        - ä¸‹è½½åŽè§£åŽ‹ï¼Œè¿è¡Œ \`./run.sh\` å¼€å§‹æ¸¸æˆ
        
        ## âœ¨ æ–°ç‰¹æ€§
        - ðŸš€ é«˜æ€§èƒ½Rust + C++æ··åˆæž¶æž„
        - ðŸŽ¨ åŸºäºŽBevyå¼•æ“Žçš„çŽ°ä»£å›¾å½¢æ¸²æŸ“
        - ðŸ”Š é«˜è´¨é‡éŸ³é¢‘ç³»ç»Ÿ
        - ðŸŒ æ”¯æŒå•æœºå’Œå¤šäººæ¨¡å¼
        - ðŸŽ® å®Œæ•´çš„å®å¯æ¢¦æˆ˜æ–—ç³»ç»Ÿ
        
        ## ðŸ’» ç³»ç»Ÿè¦æ±‚
        
        ### Windows
        - Windows 10/11 (64ä½)
        - 4GB RAM
        - DirectX 12å…¼å®¹æ˜¾å¡
        - 1GBå¯ç”¨å­˜å‚¨ç©ºé—´
        
        ### macOS
        - macOS 10.15+
        - 4GB RAM
        - Metalå…¼å®¹æ˜¾å¡
        - 1GBå¯ç”¨å­˜å‚¨ç©ºé—´
        
        ### Linux
        - Ubuntu 20.04+ æˆ–å…¼å®¹å‘è¡Œç‰ˆ
        - 4GB RAM
        - Vulkanå…¼å®¹æ˜¾å¡
        - 1GBå¯ç”¨å­˜å‚¨ç©ºé—´
        
        ## ðŸŽ¯ å¿«é€Ÿå¼€å§‹
        1. ä¸‹è½½å¯¹åº”å¹³å°çš„åŽ‹ç¼©åŒ…
        2. è§£åŽ‹åˆ°ä»»æ„ç›®å½•
        3. è¿è¡Œå¯åŠ¨è„šæœ¬å¼€å§‹æ¸¸æˆ
        4. äº«å—é«˜æ€§èƒ½å®å¯æ¢¦æ¸¸æˆä½“éªŒï¼
        
        ---
        
        **æ³¨æ„**: è¿™æ˜¯ä¸€ä¸ªå­¦ä¹ é¡¹ç›®ï¼Œä»…ä¾›æ•™è‚²ç”¨é€”ã€‚
        EOF
        
    - name: ðŸŽ‰ Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.release_notes.outputs.version }}
        name: Pokemon GO ${{ steps.release_notes.outputs.version }}
        body_path: release_notes.md
        draft: false
        prerelease: false
        files: |
          artifacts/pokemon-go-windows-x64/pokemon-go-windows-x64.zip
          artifacts/pokemon-go-macos-x64/pokemon-go-macos-x64.tar.gz
          artifacts/pokemon-go-linux-x64/pokemon-go-linux-x64.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ðŸ“Š Build Summary
      run: |
        echo "## ðŸŽ® Pokemon GO æž„å»ºå®Œæˆ!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| å¹³å° | çŠ¶æ€ | æ–‡ä»¶ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| Windows x64 | âœ… æˆåŠŸ | pokemon-go-windows-x64.zip |" >> $GITHUB_STEP_SUMMARY
        echo "| macOS x64 | âœ… æˆåŠŸ | pokemon-go-macos-x64.tar.gz |" >> $GITHUB_STEP_SUMMARY
        echo "| Linux x64 | âœ… æˆåŠŸ | pokemon-go-linux-x64.tar.gz |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸš€ **Release**: ${{ steps.release_notes.outputs.version }}" >> $GITHUB_STEP_SUMMARY